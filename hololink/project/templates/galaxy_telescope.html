{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}


{% block extracss %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" 
        integrity="sha512-3q8fi8M0VS+X/3n64Ndpp6Bit7oXSiyCnzmlx6IDBLGlY5euFySyJ46RUlqIVs0DPCGOypqP8IRk/EyPvU28mQ==" crossorigin="anonymous" />
<style>


    @media (min-width: 440px) {

    }

    @media (min-width: 576px) {

    }
    @media (min-width: 768px) {

    }
    @media (min-width: 992px) {

    }
    @media (min-width: 1200px) {}

    .collapse-controller-title:hover {
        text-decoration: none;
        color: black;
        opacity: 1;
        background-color: rgba(61, 61, 61, 0.1);
    }

    .collapse-controller-title {
        font-size: 18px;
        font-weight: 700;
        color: black;
        padding-left: 15px;
    }

    .collapse-controller-container {
        padding: 0 15px;
        width: 100%;
    }

    .force-instruction {
        font-size: 14px;
        margin-bottom: 15px;    
    }

    .force-checkbox {
        margin: 2.5px 5px 0 0;
    }
 
    .slider-selection {
        background: lightgray;
    }

    .slider-handle {
        background-color: grey;
        background-image: none;
        height: 15px;
        width: 15px;
        top: 2px;
    }

    .silder-instruction{
        font-size: 16px;
        font-weight: 700;
    }

    .slider-track {
        height: 8px !important;
    }

</style>


{% endblock %}

{% block content %}


<div class="container-fluid d-flex flex-column" style="padding:0">
    {% include 'project_dashboard_navbar_2.html' %}
    <div class="row flex-grow-1" style="margin: 20px auto; width: 90%;">
        <div class="row flex-grow-1" style="margin: auto; overflow: auto;">
            <div class="slider-container col-12 col-sm-2">
                <div class="d-flex flex-column" style="border: 1px solid #BFB9B8; border-radius: 6px; margin: 0; overflow:auto; height: 600px;">
                    <a class="collapse-controller-title" data-toggle="collapse" href="#center_force" role="button" aria-expanded="false" aria-controls="center_force" style="margin-top: 15px;">Center force</a>
                    <div class="row collapse multi-collapse collapse-controller-container" id="center_force">
                        <div class="col-12">
                            <div class="force-instruction">{% trans 'Shifts the view, so the graph is centered at this location.' %}</div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">x</div>
                            </div>
                            <div class="d-flex">
                                <input id="center_XSliderOutput">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">y</div>
                            </div>
                            <div class="d-flex">
                                <input id="center_YSliderOutput">
                            </div>
                        </div>
                    </div>
                    <div style="margin: 15px 0; border-bottom: 1px solid #BFB9B8;"></div>
                    <a class="collapse-controller-title" data-toggle="collapse" href="#charge_force" role="button" aria-expanded="false" aria-controls="charge_force">Charge force</a>
                    <div class="row collapse multi-collapse collapse-controller-container" id="charge_force">
                        <div class="col-12 d-flex">
                            <input class="force-checkbox" type="checkbox" checked onchange="forceProperties.charge.enabled = this.checked; updateAll();">
                            <div class="force-instruction">Attracts (+) or repels (-) nodes to/from each other.</div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">strength</div>
                            </div>
                            <div>
                                <input id="charge_StrengthSliderOutput">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">distanceMin</div>
                            </div>
                            <div>
                                <input id="charge_distanceMinSliderOutput">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">distanceMax</div>
                            </div>
                            <div>
                                <input id="charge_distanceMaxSliderOutput">
                            </div>
                        </div>
                    </div>
                    <div style="margin: 15px 0; border-bottom: 1px solid #BFB9B8;"></div>
                    <a class="collapse-controller-title" data-toggle="collapse" href="#collide_force" role="button" aria-expanded="false" aria-controls="collide_force">Collide force</a>
                    <div class="row collapse multi-collapse collapse-controller-container" id="collide_force">
                        <div class="col-12 d-flex">
                            <input class="force-checkbox" type="checkbox" checked onchange="forceProperties.collide.enabled = this.checked; updateAll();">
                            <div class="force-instruction">Prevents nodes from overlapping</div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">strength</div>
                                <output id="collide_StrengthSliderOutput">.7</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="0" max="2" value=".7" step=".1" oninput="d3.select('#collide_StrengthSliderOutput').text(value); forceProperties.collide.strength=value; updateAll();">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">radius</div>
                                <output id="collide_radiusSliderOutput">5</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="0" max="100" value="5" step="1" oninput="d3.select('#collide_radiusSliderOutput').text(value); forceProperties.collide.radius=value; updateAll();">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">iterations</div>
                                <output id="collide_iterationsSliderOutput">1</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="1" max="10" value="1" step="1" oninput="d3.select('#collide_iterationsSliderOutput').text(value); forceProperties.collide.iterations=value; updateAll();">
                            </div>
                        </div>
                    </div>
                    <div style="margin: 15px 0; border-bottom: 1px solid #BFB9B8;"></div>
                    <a class="collapse-controller-title" data-toggle="collapse" href="#x_force" role="button" aria-expanded="false" aria-controls="x_force">X force</a>
                    <div class="row collapse multi-collapse collapse-controller-container" id="x_force">
                        <div class="col-12 d-flex">
                            <input class="force-checkbox" type="checkbox" onchange="forceProperties.forceX.enabled = this.checked; updateAll();">
                            <div class="force-instruction">Acts like gravity. Pulls all points towards an X location.</div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">strength</div>
                                <output id="forceX_StrengthSliderOutput">.1</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="0" max="1" value=".1" step="0.01" oninput="d3.select('#forceX_StrengthSliderOutput').text(value); forceProperties.forceX.strength=value; updateAll();">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">x</div>
                                <output id="forceX_XSliderOutput">.5</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="0" max="1" value=".5" step="0.01" oninput="d3.select('#forceX_XSliderOutput').text(value); forceProperties.forceX.x=value; updateAll();">
                            </div>
                        </div>
                    </div>
                    <div style="margin: 15px 0; border-bottom: 1px solid #BFB9B8;"></div>
                    <a class="collapse-controller-title" data-toggle="collapse" href="#y_force" role="button" aria-expanded="false" aria-controls="y_force">Y force</a>
                    <div class="row collapse multi-collapse collapse-controller-container" id="y_force">
                        <div class="col-12 d-flex">
                            <input class="force-checkbox" type="checkbox" onchange="forceProperties.forceY.enabled = this.checked; updateAll();">
                            <div class="force-instruction">Acts like gravity. Pulls all points towards a Y location.</div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">strength</div>
                                <output id="forceY_StrengthSliderOutput">.1</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="0" max="1" value=".1" step="0.01" oninput="d3.select('#forceY_StrengthSliderOutput').text(value); forceProperties.forceY.strength=value; updateAll();">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">y</div>
                                <output id="forceY_YSliderOutput">.5</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="0" max="1" value=".5" step="0.01" oninput="d3.select('#forceY_YSliderOutput').text(value); forceProperties.forceY.y=value; updateAll();">
                            </div>
                        </div>
                    </div>
                    <div style="margin: 15px 0; border-bottom: 1px solid #BFB9B8;"></div>
                    <a class="collapse-controller-title" data-toggle="collapse" href="#link_force" role="button" aria-expanded="false" aria-controls="link_force">Link force</a>
                    <div class="row collapse multi-collapse collapse-controller-container" id="link_force">
                        <div class="col-12 d-flex">
                            <input class="force-checkbox" type="checkbox" checked onchange="forceProperties.link.enabled = this.checked; updateAll();">
                            <div class="force-instruction">Sets link length and strength</div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">distance</div>
                                <output id="link_DistanceSliderOutput">50</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="0" max="100" value="50" step="1" oninput="d3.select('#link_DistanceSliderOutput').text(value); forceProperties.link.distance=value; updateAll();">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex">
                                <div class="silder-instruction">strength</div>
                                <output id="link_StrengthSliderOutput">30</output>
                            </div>
                            <div class="d-flex">
                                <input type="range" min="0" max="1" value="0.5" step="0.01" oninput="d3.select('#link_StrengthSliderOutput').text(value); forceProperties.link.strength=value; updateAll();">
                            </div>
                        </div>
                    </div>
                    <div style="margin: 15px 0; border-bottom: 1px solid #BFB9B8;"></div>
                </div>
                
            </div>
            <div class="col-12 col-sm-8">
                <div class="row h-100" style="border: 1px solid #BFB9B8; border-radius: 6px; margin: 0;">
                    <div class="col" style="padding: 0;">
                        <svg width="100%" height="100%"></svg>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-2">
                <div class="d-flex flex-column" style="border: 1px solid #BFB9B8; border-radius: 6px; margin: 0; overflow:auto; height: 600px;">
                    <a class="collapse-controller-title" data-toggle="collapse" href="#filter" role="button" aria-expanded="false" aria-controls="filter" style="margin-top: 15px;">Filter</a>
                    <div class="row collapse multi-collapse collapse-controller-container" id="filter">

                    </div>
                    <div style="margin: 15px 0; border-bottom: 1px solid #BFB9B8;"></div>
                    <a class="collapse-controller-title" data-toggle="collapse" href="#display" role="button" aria-expanded="false" aria-controls="filter">Display</a>
                    <div class="row collapse multi-collapse collapse-controller-container" id="display">

                    </div>
                    <div style="margin: 15px 0; border-bottom: 1px solid #BFB9B8;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js" 
    integrity="sha512-f0VlzJbcEB6KiW8ZVtL+5HWPDyW1+nJEjguZ5IVnSQkvZbwBt2RfCBY0CBO1PsMAqxxrG4Di6TfsCPP3ZRwKpA==" crossorigin="anonymous">
</script>

<script>

    $('#center_XSliderOutput').slider({
        min:0,
        max:1,
        value:0.5,
        step:0.01,
    });

    $('#center_XSliderOutput').on("change", function(event){
        forceProperties.center.x=event.value.newValue; 
        updateAll();
    });

    $('#center_YSliderOutput').slider({
        min:0,
        max:1,
        value:0.5,
        step:0.01,
    });

    $('#center_YSliderOutput').on("change", function(event){
        forceProperties.center.y=event.value.newValue; 
        updateAll();
    });

    $('#charge_StrengthSliderOutput').slider({
        min:-200,
        max:50,
        value:-30,
        step:1,
    });

    $('#charge_StrengthSliderOutput').on("change", function(event){
        forceProperties.charge.strength=event.value.newValue; 
        updateAll();
    });

    $('#charge_distanceMinSliderOutput').slider({
        min:0,
        max:50,
        value:1,
        step:1,
    });

    $('#charge_distanceMinSliderOutput').on("change", function(event){
        forceProperties.charge.distanceMin=event.value.newValue; 
        updateAll();
    });

    $('#charge_distanceMaxSliderOutput').slider({
        min:0,
        max:2000,
        value:2000,
        step:1,
    });

    $('#charge_distanceMaxSliderOutput').on("change", function(event){
        forceProperties.charge.distanceMax=event.value.newValue; 
        updateAll();
    });


</script>

<script>
    var svg = d3.select("svg"),
        width = +svg.node().getBoundingClientRect().width,
        height = +svg.node().getBoundingClientRect().height;

    // for zoom 
    var g = svg.append("g")
        .attr("class", "everything");

    // svg objects
    var link, node;
    // the data - an object with nodes and links
    var graph;

    //limit font-size when scaling
    var max_text_size = 18
        nominal_text_size = 8;

    const linkedByIndex = {};

    const simulationDurationInMs = 5000; // 2 seconds

    var startTime = Date.now();
    var endTime = startTime + simulationDurationInMs;


    // load the data
    d3.json('{% url "project:deliver_D3" projectnameslug=project.slug usernameslug=user.profile.slug%}', function(error, data) {
        if (error) throw error;
        graph = data.graph;
        initializeSimulation();
        initializeDisplay();

         // create a index to allow constant-time lookup with good performance
        // This must put after simulation, after that we can access the d3 calculated info
        
        graph.links.forEach(d => {
            linkedByIndex[`${d.source.index},${d.target.index}`] = 1;
        });

    });



    //////////// FORCE SIMULATION //////////// 

    // force simulator
    var simulation = d3.forceSimulation();

    // set up the simulation and event to update locations after each tick
    function initializeSimulation() {
        simulation.nodes(graph.nodes);
        initializeForces();
        simulation.on("tick", ticked);
    }

    // values for all forces
    forceProperties = {
        center: {
            x: 0.5,
            y: 0.5,
        },
        charge: {
            enabled: true,
            strength: -30,
            distanceMin: 1,
            distanceMax: 2000
        },
        collide: {
            enabled: true,
            strength: .7,
            iterations: 1,
            radius: 5
        },
        forceX: {
            enabled: false,
            strength: .1,
            x: .5
        },
        forceY: {
            enabled: false,
            strength: .1,
            y: .5
        },
        link: {
            enabled: true,
            distance: 50,
            iterations: 1,
            strength: 0.3,
        }
    }

    // other properties
    otherProperties = {
        zoom_threshhold_of_displaying_label:1
    }

    // add forces to the simulation
    function initializeForces() {
        // add forces and associate each with a name
        simulation
            .force("link", d3.forceLink())
            .force("charge", d3.forceManyBody())
            .force("collide", d3.forceCollide())
            .force("center", d3.forceCenter())
            .force("forceX", d3.forceX())
            .force("forceY", d3.forceY());
        // apply properties to each of the forces
        updateForces();

    }
    
    // apply new force properties
    function updateForces() {
        // get each force by name and update the properties
        simulation.force("center")
            .x(width * forceProperties.center.x)
            .y(height * forceProperties.center.y);
        simulation.force("charge")
            .strength(forceProperties.charge.strength * forceProperties.charge.enabled)
            .distanceMin(forceProperties.charge.distanceMin)
            .distanceMax(forceProperties.charge.distanceMax);
        simulation.force("collide")
            .strength(forceProperties.collide.strength * forceProperties.collide.enabled)
            .radius(forceProperties.collide.radius)
            .iterations(forceProperties.collide.iterations);
        simulation.force("forceX")
            .strength(forceProperties.forceX.strength * forceProperties.forceX.enabled)
            .x(width * forceProperties.forceX.x);
        simulation.force("forceY")
            .strength(forceProperties.forceY.strength * forceProperties.forceY.enabled)
            .y(height * forceProperties.forceY.y);
        simulation.force("link")
            .id(function(d) {return d.id;})
            .distance(forceProperties.link.distance)
            .strength(forceProperties.link.strength)
            .iterations(forceProperties.link.iterations)
            .links(forceProperties.link.enabled ? graph.links : []);

        // updates ignored until this is run
        // restarts the simulation (important if simulation has already slowed down)
        simulation
            .alphaDecay(0.01)
            .alpha(0.8).restart();
    }

    //////////// DISPLAY ////////////

    // generate the svg objects and force simulation
    function initializeDisplay() {
        // set the data and properties of link lines
        link = g.append("g")
                .attr("class", "links")
            .selectAll("line")
                .data(graph.links)
                .enter()
                .append("line")

        // set the data and properties of node circles
        node = g.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(graph.nodes)
            .enter().append("g")
            

        node
            .append("circle")
            .attr('connection', function(d){
                return d.connection
            })
            .attr('r', getNodeSize)
            .on('mouseover.fade', fade(0.2))
            .on('mouseout.fade', fade(1));
        
        node
            .append("text")
            .text(node => node.id)
            .attr('dy', '.5rem')
            .style('font-weight', '500')
            .style('font-size', nominal_text_size + "px")
            .style('opacity', 0)
            .attr('text-anchor', 'middle')
            .on('mouseover.fade', fade(0.2))
            .on('mouseout.fade', fade(1));
            //.style('fill', 'black')
                
                
        /*
        textContainer = g.append("g")
            .attr("class", "textContainer")
                .selectAll("foreignObject")
                .data(graph.nodes)                   
                .enter()
                    .append('foreignObject')
                    

        
        text = textContainer.append('xhtml:text')
            .text(node => node.id)
            .style('display', 'flex')
            .style('width', '100%')
            .style('height', '100%')
            .style('justify-content', 'center')
            .style('align-items','center')
            .style('font-family', "'Noto Sans TC', sans-serif")
            .style('font-weight', '500')
            .style('font-size', nominal_text_size + "px")
            .style('fill', 'black')

        */

        // node tooltip
        node.append("title")
            .text(function(d) { return d.id; });
        // visualize the graph
        

        var zoom_handler = d3.zoom()
            .on("zoom", zoom_actions)
            .scaleExtent([0.1, 10]); //set zoom in and out limit

        zoom_handler(svg);

        var drag_handler = d3.drag()
            .on("start", drag_start)
            .on("drag", drag_drag)
            .on("end", drag_end);	

        drag_handler(node);

        updateDisplay();
    }

    // update the display based on the forces (but not positions)
    function updateDisplay() {

        link
            .attr("stroke-width", forceProperties.link.enabled ? 0.5 : .2)
            .attr("opacity", forceProperties.link.enabled ? 1 : 0)
            .style("stroke", 'grey');
        /*
        textContainer
            .style('width', getTextWrapperXSpace)
            .style('height', getTextWrapperYSpace)
        
        
        text
            .style('opacity', function(node){
                if (node.connection > 2) { return 1 }
                else { return 0 }
            })
        */
    }

    // update the display positions after each simulation tick
    function ticked() {
        if (Date.now() < endTime) {
            link
            .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

            node
                .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                .attr("r", getNodeSize)

            /*
            node
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; })
                .attr("r", getNodeSize)
                //.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
            */

            //text
                //.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        } else {
            simulation.stop();
        }
        
        
    }


    //DRAG FUNCTION
    function drag_start(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    //make sure you can't drag the circle outside the box
    function drag_drag(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function drag_end(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = d.x; //sticky node
        d.fy = d.y; //sticky node
        startTime = Date.now();
        endTime = startTime + simulationDurationInMs;
    }

    //ZOOM FUNCTION
    function zoom_actions(){
        g.attr("transform", d3.event.transform)
        transform = d3.event.transform

        if (transform.k < otherProperties.zoom_threshhold_of_displaying_label){
            svg.selectAll('text').style("opacity",0)
        } else if ( otherProperties.zoom_threshhold_of_displaying_label += 0.5 > transform.k >= otherProperties.zoom_threshhold_of_displaying_label) {
            svg.selectAll('text').style("opacity",transform.k - otherProperties.zoom_threshhold_of_displaying_label)
        } else {
            svg.selectAll('text').style("opacity",1)
        }

        var text_size = nominal_text_size
        if (nominal_text_size*transform.k > max_text_size){
            text_size = max_text_size/transform.k
        }
        svg.selectAll('text').style('font-size', text_size)

    }

    function getNodeSize(node){
        return 2
    }

    function getTextWrapperXSpace(node){
        return 50
    }

    function getTextWrapperYSpace(node){
        return 20
    }

    // update size-related forces
    d3.select(window).on("resize", function(){
        width = +svg.node().getBoundingClientRect().width;
        height = +svg.node().getBoundingClientRect().height;
        updateForces();
    });

    //Implement FADE IN and OUT EFFECT ------------

    function fade(opacity){
            return d => {
                //判斷 node 是否相連，若沒有則套用 opacity
                node.style('opacity', function (o) { return isConnected(d, o) ? 1 : opacity });
                //判斷連結的 source 或 target 是否為 d 若沒有則套用 opacity
                link.style('stroke-opacity', o => (o.source === d || o.target === d ? 1 : opacity));
                //When mouseout reset opacity
                if(opacity === 1){
                    node.style('opacity', 1)
                    link.style('stroke-opacity', 0.5)
                }
            };
        }

    function isConnected(a, b) {
        return linkedByIndex[`${a.index},${b.index}`] || linkedByIndex[`${b.index},${a.index}`] || a.index === b.index;
    }

    // convenience function to update everything (run after UI input)
    function updateAll() {
        startTime = Date.now();
        endTime = startTime + simulationDurationInMs;
        updateForces();
        updateDisplay();
    }
</script>

{% endblock %}