{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<style>
    @media (min-width: 440px) {}
    @media (min-width: 576px) {}
    @media (min-width: 768px) {}
    @media (min-width: 992px) {}
    @media (min-width: 1200px) {}
    .body{
        font-smooth: auto;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .content-container{
        margin: 50px auto 0 auto;
        
        
    }

    .family-button{
        border-radius: 50px;
        font-size: 16px;
        font-weight: 700;
        padding: 5px 12px;
        color: azure;
        border:none;
        transition: 0.3s ease;
        margin-right: 10px;
    }

    .family-button:hover{
        color: azure;
        box-shadow: rgba(10, 10, 10, 0.4) 0px 2px 2px 0px;
        text-decoration: none;
        transition: 0.3s ease;
    }

    .article-title{
        font-size: 36px;
        font-weight: 900;
        margin-top: 20px;
        line-height: 52px;
    }

    .article-url{
        color: #2a9d8f;
    }

    .article-text-container{
        border-radius: 5px;
        border: 1px solid #ECF0F1;
        background-color: white;
        padding: 25px 50px !important;
        font-size: 16px;
    }

    {% comment %}
    Hololink custome style of headers
    {% endcomment %}

    h1 {
        display: block;
        font-size: 42px;
        margin-top: 54px;
        margin-bottom: 20px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 900;
    }

    h2 {
        display: block;
        font-size: 36px;
        margin-top: 45px;
        margin-bottom: 18px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 900;
    }

    h3 {
        display: block;
        font-size: 28px;
        margin-top: 36px;
        margin-bottom: 16px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 700;
    }

    h4 {
        display: block;
        font-size: 24px;
        margin-top: 24px;
        margin-bottom: 16px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 700;
    }

    h5 {
        display: block;
        font-size: 20px;
        margin-top: 20px;
        margin-bottom: 16px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 700;
    }

    h6 {
        display: block;
        font-size: 18px;
        margin-top: 18px;
        margin-bottom: 16px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 700;
    }

    p { 
        line-height: 1.85rem;
        font-size: 18px;
        margin-bottom: 24px;
    }

    hololink-highlight{
        background-color: #e9c46a;
    }

    a {
        color: blue;
    }

    .article-navigator-container{
        padding-top: 0px;
        padding-right: 20px;
        padding-bottom: 10px;
        padding-left: 10px;
        
        position: sticky;
        top: 0;
    }

    .article-navigator{
        
        border: 1px solid #ECF0F1;
        padding: 10px;
        background-color: white;
        border-radius: 5px;
    }

    html {
        scroll-behavior: smooth;
    }

</style>


<div class="container-fluid d-flex" style="background-color: #eeeeee;">
    <div class="content-container">
        <div class="row no-gutters">
            <div class="col-3"></div>
            <div class="col-6">
                <div class="row no-gutters">
                    <a href="{% url 'article:articles_list' usernameslug=user.profile.slug%}" class="family-button" style="background-color: #264653;">Articles</a>
                    {% for project in article.projects.all %}
                    <a href="#" class="family-button" style="background-color: #2a9d8f;">{{project.name}}</a>
                    {% endfor %}
                </div>
                <div class="row article-title no-gutters">
                    <div class="col">
                        {{article.name}}
                    </div>
                </div>
                <div class="row no-gutters" style="margin-top: 10px;">
                    <a target="_blank" rel="noopener noreferrer" href="{{ article.from_url }}" class="article-url">
                        <svg style="margin-bottom: 3px;" width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-box-arrow-up-right" fill="#2a9d8f" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                        </svg>
                        {{ article.from_url|truncatechars:120 }}
                    </a>
                </div>
            </div>
            <div class="col-3"></div>
        </div>
        <div class="row no-gutters" style="margin: 60px 0;">
            <div class="col-3">
                <div class="article-navigator-container">
                    <div class="article-navigator">
                        <div class="row no-gutters" style="font-size: 18px;">
                            <a class="col nav-link" href="{% url 'article:article_detail' articlenameslug=article.slug usernameslug=user.profile.slug %}#▌土耳其「西化運動」的興起與反挫">土耳其「西化運動」的興起與反挫</a>
                        </div>
                        <div class="row no-gutters" style="font-size: 16px; padding-left: 18px; margin-top: 10px;">
                            被極化的「言論自由」單選題
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 article-text-container">
                {{ article.article_html | safe }}
            </div>
            <div class="col-3 article-highlight-container">

            </div>
        </div>
        
    </div>
</div>

{% endblock %}

{% block extrajs %}
{{highlights|json_script:"highlights"}}
<script type="text/javascript" src="{% static 'js/article/jquery-3.5.1.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/article/jquery.mark.min.js' %}"></script>
<script>

    // Build up article-navigator 

    var navigationHeaderStyle = [
        {fontSize:18, pedding:0},
        {fontSize:16, pedding:18},
        {fontSize:14, pedding:16},
        {fontSize:12, pedding:14},
        {fontSize:12, pedding:12},
        {fontSize:12, pedding:12},
    ]

    var articleHeaders = [...document.querySelectorAll('h1, h2, h3, h4, h5, h6')]

    const biggestHeader = articleHeaders[0].nodeName.replace('H', '')
    var articleHeadersNum = []
    for (var i=0; i<articleHeaders.length; i++){
        var tagNumber = articleHeaders[i].nodeName.replace('H', '')
        articleHeadersNum.push(tagNumber)
        articleHeaders[i].setAttribute('id', `${articleHeaders[i].textContent}`)
    }

    
    var uniqueArticleHeadersNum = [... new Set(articleHeadersNum)]
    uniqueArticleHeadersNum.sort(function(a,b){
        if (a > b){
            return 1
        }
        if (a < b){
            return -1
        }
        if (a = b){
            return 0
        }
    });
    for (var i=0; i<articleHeaders.length; i++){
        var tagNumber = articleHeaders[i].nodeName.replace('H', '')
        var index = uniqueArticleHeadersNum.indexOf(tagNumber)
    }


    // make article navigator sticky at right position when we scroll up

    $(window).scroll(updateArticleNavigator)
    const articleNavigatorHeight = $('.article-text-container').offset().top
    function updateArticleNavigator(){
        $('.article-navigator-container').each(function(){
            console.log($(window).scrollTop(), articleNavigatorHeight)
            if ($(window).scrollTop() > articleNavigatorHeight){
                $(this).css({"padding-top":"20px"})
            } else {
                $(this).css({"padding-top":"0px"})
            }
        })
    }


    var tempHighlightOptions = {
        "element": "hololink-highlight",
        "className": "",
        "exclude": [],
        "separateWordSearch": false,
        "accuracy": "partially",
        "diacritics": true,
        "synonyms": {},
        "iframes": false,
        "iframesTimeout": 5000,
        "acrossElements": true,
        "caseSensitive": false,
        "ignoreJoiners": true,
        "ignorePunctuation": [],
        "wildcards": "disabled",
        "each": function(node){
            // node is the marked DOM element
            node.setAttribute("data-id", highlightsData[i].id_on_page);
        },
        "filter": function(textNode, foundTerm, totalCounter, counter){
            // textNode is the text node which contains the found term
            // foundTerm is the found search term
            // totalCounter is a counter indicating the total number of all marks
            // at the time of the function call
            // counter is a counter indicating the number of marks for the found term
            return true
            
        },
        "noMatch": function(term){
            // term is the not found term
        },
        "done": function(counter){
            // counter is a counter indicating the total number of all marks
        },
        "debug": false,
        "log": window.console,
    };
    

    var target = document.getElementsByClassName('article-text-container');
    var textTreeWalker = document.createTreeWalker(target[0], NodeFilter.SHOW_TEXT);
    var nodeList = {}
    var currentNode = textTreeWalker.currentNode;
    while(currentNode) {
        nodeList[`${currentNode.parentNode.textContent}`] = currentNode.parentNode
        currentNode = textTreeWalker.nextNode();
    }

    var highlightsData = JSON.parse(document.getElementById('highlights').textContent);
    for (var i=0; i<highlightsData.length; i++){

        var targetNode = nodeList[`${highlightsData[i].anchor_point_data.highlight_parent_node_text}`]
        var instance = new Mark(targetNode);
        instance.mark(highlightsData[i].text, tempHighlightOptions);

        var highlightedElemets = document.querySelectorAll(`[data-id^="${highlightsData[i].id_on_page}"]`);
        //console.log(highlightsData[i], highlightedElemets)

        var highlightedTextCollection = ''
        var highlightedNodesCollection = {}
        var collectionGroup = 0

        for (var j=0; j<highlightedElemets.length; j++){
            
            if (highlightedTextCollection != highlightsData[i].text){
                highlightedTextCollection = highlightedTextCollection + highlightedElemets[j].textContent
                if (highlightedNodesCollection[`${collectionGroup}`]){
                    highlightedNodesCollection[`${collectionGroup}`].push(highlightedElemets[j])
                } else {
                    highlightedNodesCollection[`${collectionGroup}`] = [highlightedElemets[j]]
                }
            } else {
                highlightedTextCollection = ''
                collectionGroup = collectionGroup + 1
                highlightedTextCollection = highlightedTextCollection + highlightedElemets[j].textContent
                if (highlightedNodesCollection[`${collectionGroup}`]){
                    highlightedNodesCollection[`${collectionGroup}`].push(highlightedElemets[j])
                } else {
                    highlightedNodesCollection[`${collectionGroup}`] = [highlightedElemets[j]]
                }
                //console.log('hehe')
            }
        }

        for (const [key, value] of Object.entries(highlightedNodesCollection)){
            var selectRange = document.createRange()
            selectRange.setStartBefore(value[0])
            selectRange.setEndAfter(value[ value.length - 1 ])
            var preCaretRange = selectRange.cloneRange();
            preCaretRange.selectNodeContents(targetNode);
            preCaretRange.setEnd(selectRange.endContainer, selectRange.endOffset);
            caretOffset = preCaretRange.toString().length;
            if (caretOffset != highlightsData[i].anchor_point_data.character_offset){
                for (k=0; k<value.length; k++){
                    unWrapElement(value[k])
                }
                //console.log('not match', value, caretOffset, highlightsData[i].text.length)
            } else {
                //console.log('match',value, caretOffset)
            }
            
        }
    }

    function unWrapElement(target){
        // place childNodes in document fragment
        var docFrag = document.createDocumentFragment();
        while (target.firstChild) {
            var child = target.removeChild(target.firstChild);
            docFrag.appendChild(child);
        }
        // replace wrapper with document fragment
        //console.log(target)
        if (target.parentNode){
            target.parentNode.replaceChild(docFrag, target);
        }
    };
</script>


{% endblock %}
