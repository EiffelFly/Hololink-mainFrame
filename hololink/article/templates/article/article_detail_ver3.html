{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<style>
    @media (min-width: 440px) {}
    @media (min-width: 576px) {}
    @media (min-width: 768px) {}
    @media (min-width: 992px) {}
    @media (min-width: 1200px) {}
    .body{
        font-smooth: auto;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .content-container{
        margin: 50px auto 0 auto;
        
        
    }

    .family-button{
        border-radius: 50px;
        font-size: 16px;
        font-weight: 700;
        padding: 5px 12px;
        color: azure;
        border:none;
        transition: 0.3s ease;
        margin-right: 10px;
    }

    .family-button:hover{
        color: azure;
        box-shadow: rgba(10, 10, 10, 0.4) 0px 2px 2px 0px;
        text-decoration: none;
        transition: 0.3s ease;
    }

    .article-title{
        font-size: 48px;
        font-weight: 900;
        margin-top: 20px;
        line-height: 50px;
    }

    .article-url{
        color: #2a9d8f;
    }

    .article-text-container{
        border-radius: 5px;
        border: 1px solid #ECF0F1;
        background-color: white;
        padding: 25px 50px !important;
        font-size: 16px;
    }

    {% comment %}
    Hololink custome style of headers
    {% endcomment %}

    h1 {
        display: block;
        font-size: 36px;
        margin-top: 54px;
        margin-bottom: 18px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 900;
    }

    h2 {
        display: block;
        font-size: 30px;
        margin-top: 45px;
        margin-bottom: 15px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 900;
    }

    h3 {
        display: block;
        font-size: 24px;
        margin-top: 36px;
        margin-bottom: 15px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 700;
    }

    h4 {
        display: block;
        font-size: 18px;
        margin-top: 18px;
        margin-bottom: 15px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 700;
    }

    h5 {
        display: block;
        font-size: 16px;
        margin-top: 16px;
        margin-bottom: 15px;
        margin-left: 0;
        margin-right: 0;
        font-weight: 700;
    }

    hololink-highlight{
        background-color: #e9c46a;
    }

</style>


<div class="container-fluid d-flex" style="background-color: #F7F9F9;">
    <div class="content-container">
        <div class="row no-gutters">
            <div class="col flex-column">
                <a href="{% url 'article:articles_list' usernameslug=user.profile.slug%}" class="family-button" style="background-color: #264653;">Articles</a>
                {% for project in article.projects.all %}
                <a href="#" class="family-button" style="background-color: #2a9d8f;">{{project.name}}</a>
                {% endfor %}
            </div>
        </div>
        <div class="row article-title no-gutters">
            {{article.name}}
        </div>
        <div class="row no-gutters" style="margin-top: 10px;">
            <div class="col">
                <a target="_blank" rel="noopener noreferrer" href="{{ article.from_url }}" class="article-url">
                    <svg style="margin-bottom: 3px;" width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-box-arrow-up-right" fill="#2a9d8f" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                        <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                    </svg>
                    {{ article.from_url|truncatechars:120 }}
                </a>
            </div>
        </div>
        <div class="row no-gutters"></div>
        <div class="row no-gutters" style="margin: 100px 0;">
            <div class="col-2 article-header-container"></div>
            <div class="col-5 article-text-container">
                {{ article.article_html | safe }}
            </div>
            <div class="col-5 article-highlight-container">

            </div>
        </div>
        
    </div>
</div>

{% endblock %}

{% block extrajs %}
{{highlights|json_script:"highlights"}}
<script type="text/javascript" src="{% static 'js/article/jquery-3.5.1.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/article/jquery.mark.min.js' %}"></script>
<script>

    var highlightCounter = 0
    var currentHighlight
    var targetHighlightSets = {}

    var tempHighlightOptions = {
        "element": "hololink-highlight",
        "className": "",
        "exclude": [],
        "separateWordSearch": false,
        "accuracy": "partially",
        "diacritics": true,
        "synonyms": {},
        "iframes": false,
        "iframesTimeout": 5000,
        "acrossElements": true,
        "caseSensitive": false,
        "ignoreJoiners": false,
        "ignorePunctuation": [],
        "wildcards": "disabled",
        "each": function(node){
            // node is the marked DOM element
        },
        "filter": function(textNode, foundTerm, totalCounter, counter){
            // textNode is the text node which contains the found term
            // foundTerm is the found search term
            // totalCounter is a counter indicating the total number of all marks
            // at the time of the function call
            // counter is a counter indicating the number of marks for the found term
            console
            
        },
        "noMatch": function(term){
            // term is the not found term
        },
        "done": function(counter){
            // counter is a counter indicating the total number of all marks
        },
        "debug": false,
        "log": window.console,
        "each": function(node){
            if (targetHighlightSets[`${highlightsData[i].id_on_page}`]){
                targetHighlightSets[`${highlightsData[i].id_on_page}`].push(node)
            } else {
                targetHighlightSets[`${highlightsData[i].id_on_page}`] = [node]
            }
            node.setAttribute("data-id", highlightsData[i].id_on_page);
        }
    };

    var highlightOptions = {
        "element": "hololink-highlight",
        "className": "",
        "exclude": [],
        "separateWordSearch": false,
        "accuracy": "partially",
        "diacritics": true,
        "synonyms": {},
        "iframes": false,
        "iframesTimeout": 5000,
        "acrossElements": true,
        "caseSensitive": false,
        "ignoreJoiners": false,
        "ignorePunctuation": [],
        "wildcards": "disabled",
        "each": function(node){
            console.log(node)
            // node is the marked DOM element
        },
        "filter": function(textNode, foundTerm, totalCounter, counter){
            // textNode is the text node which contains the found term
            // foundTerm is the found search term
            // totalCounter is a counter indicating the total number of all marks
            // at the time of the function call
            // counter is a counter indicating the number of marks for the found term
            console.log(textNode, foundTerm, totalCounter, counter)
            return true
        },
        "noMatch": function(term){
            // term is the not found term
        },
        "done": function(counter){
            // counter is a counter indicating the total number of all marks
        },
        "debug": false,
        "log": window.console,
    };

    // the django way of delievering data to javascript, meanwhile, prevent xss attacks
    // ref:https://docs.djangoproject.com/en/dev/ref/templates/builtins/#json-script

    var highlightsData = JSON.parse(document.getElementById('highlights').textContent);
    //console.log(highlightsData)
    currentHighlight = highlightsData[0].id_on_page
    for (var i=0; i<highlightsData.length; i++){
        $('.article-text-container').mark(highlightsData[i].text, tempHighlightOptions);
        
        var distanceToOriginalPageHighlight = []
        var targetHighlight = targetHighlightSets[`${highlightsData[i].id_on_page}`]

        for (var j=0; j<targetHighlight.length; j++){
            distanceToOriginalPageHighlight.push(Math.abs(targetHighlight[j].offsetTop - highlightsData[i].range_object.offsetTop))
        }
        console.log(distanceToOriginalPageHighlight)
        var targetHighlightIndex = distanceToOriginalPageHighlight.indexOf(Math.min(...distanceToOriginalPageHighlight))
        console.log(targetHighlightIndex)

        //$('.article-text-container').unmark();
        //$('.article-text-container').mark(highlightsData[i].text, highlightOptions);

    }
    
    console.log(targetHighlightSets)


</script>


{% endblock %}
